# Работа с SSH-ключами в CI/CD
В современном DevOps-процессе часто возникает необходимость использования SSH-ключей для автоматизации задач. Данная статья описывает процесс работы с SSH-ключами, включая их кодирование в base64 и настройку в CI/CD пайплайнах.

### Кодирование SSH-ключа в base64
#### Подготовка ключа
Для безопасного хранения приватного ключа в CI/CD системе необходимо закодировать его в формате base64.

```bash
  $ cat gitlab | base64 -w0
  $ cat .ssh/id_ed25519 | base64 -w0
```

После выполнения команды вы получите закодированную строку вида:
```bash
  # LS0...S0tLQo=
```

### Настройка переменной в CI/CD
#### Добавление ключа в проект
- Перейдите в настройки проекта: https://<проект>-/settings/ci_cd
- Выберите раздел Visibility
- Установите параметры:
 - Masked and hidden - включить
 - Protect variable - отключить
 - Expand variable reference - отключить
- Создайте новую переменную:
  - Key: SSH_PRIVATE_KEY
  - Value: закодированная строка ключа

### Использование ключа в пайплайне
#### Базовый пример чтения ключа
```yaml
  echo $SSH_PRIVATE_KEY | base64 -d | tr -d '\r' | ssh-add -
```

#### Полный пример конфигурации
```yaml
  before_script:
    # Установка ssh-agent если отсутствует
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh )'

    # Инициализация ssh-agent
    - eval $(ssh-agent -s)

    # Добавление приватного ключа
    - echo $SSH_PRIVATE_KEY | base64 -d | tr -d '\r' | ssh-add -

    # Настройка директории .ssh
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    # Добавление хоста в known_hosts
    - ssh-keyscan $DEV_IPADDRESS >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
```

### Важные замечания
- Всегда используйте защищенное соединение при передаче ключей
- Храните приватные ключи в защищенных переменных CI/CD
- Регулярно обновляйте ключи безопасности
- Проверяйте права доступа к файлам ключей

### Устранение типичных проблем
- Ошибка при добавлении ключа: проверьте корректность кодировки base64
- Проблемы с подключением: убедитесь в правильности настройки known_hosts
- Отсутствие ssh-agent: установите необходимые пакеты

Следуя данным инструкциям, вы сможете безопасно настроить работу с SSH-ключами в вашем CI/CD процессе.
