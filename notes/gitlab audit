audit-job:
  stage: audit-stage
  tags:
    - bff
  script:
    - echo 'üîç –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ npm-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...'
    - echo '–í–µ—Ç–≤—å $CI_COMMIT_BRANCH, Commit $CI_COMMIT_SHORT_SHA'

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
    - if [ -f "package-lock.json" ]; then npm ci; else npm install; fi

    # –ë–∞–∑–æ–≤—ã–π –∞—É–¥–∏—Ç —Å –≤—ã–≤–æ–¥–æ–º –≤ –∫–æ–Ω—Å–æ–ª—å (–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏)
    - npm audit --audit-level=moderate

    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞—É–¥–∏—Ç —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º
    - echo '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON‚Äë–æ—Ç—á—ë—Ç–∞...'
    - npm audit --json --audit-level=critical > security-audit-report.json

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—Ç—á—ë—Ç–∞ –∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    - |
      if [ -f security-audit-report.json ] && [ -s security-audit-report.json ]; then
        echo 'üìä –û—Ç—á—ë—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞—É–¥–∏—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: security-audit-report.json'
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ jq (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
        if command -v jq > /dev/null; then
          CRITICAL_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' security-audit-report.json)
          echo "–ù–∞–π–¥–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: $CRITICAL_COUNT"
        else
          # –†–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ grep
          CRITICAL_COUNT=$(grep -o '"critical": *[0-9]+' security-audit-report.json | sed 's/.*: *//')
          if [ -z "$CRITICAL_COUNT" ]; then
            CRITICAL_COUNT=0
          fi
          echo "–ù–∞–π–¥–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (—á–µ—Ä–µ–∑ grep): $CRITICAL_COUNT"
        fi
      else
        echo '‚ö†Ô∏è –û—Ç—á—ë—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç ‚Äî —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.'
      fi

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ (–ø–æ–ª–µ–∑–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)
    - echo '–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...'

    - npm ci
    - npm-check-updates --version
    - npx npm-check-updates --target minor --jsonAll > outdated-dependencies.json
    - echo '–°–ø–∏—Å–æ–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω outdated-dependencies.json'

    - echo '‚úÖ –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω.'

  rules:
    - if: $CI_COMMIT_BRANCH == 're-2026'
      when: always  # –í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ DEV, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å
    - when: never  # –ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–µ—Ç–æ–∫

  artifacts:
    paths:
      - security-audit-report.json
      - outdated-dependencies.json
    expire_in: 1 week
    reports:
      dependency_scanning: security-audit-report.json

  timeout: 10m

  interruptible: true  # –ú–æ–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å, –µ—Å–ª–∏ –∑–∞–ø—É—à–µ–Ω –Ω–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω
  environment: development
